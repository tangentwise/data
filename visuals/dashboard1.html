<!DOCTYPE html>
<html> 
<head>
    <title>Tangentwise Sector Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #0366d6; 
            --bg: #f8f9fa; 
            --border: #e1e4e8; 
            --text: #1a1a1a; 
            --success: #28a745; 
            --danger: #d73a49; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 20px; 
            color: var(--text); 
            background: white; 
            line-height: 1.5; 
        }

        /* Dashboard Header */
        .dashboard-header { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 25px; 
            background: var(--bg); 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            align-items: flex-end; 
        }
        .group { display: flex; flex-direction: column; gap: 8px; }
        .label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #6a737d; }

        select.nav-dropdown { 
            padding: 10px; border-radius: 6px; border: 1px solid var(--border); 
            font-size: 14px; font-weight: 600; min-width: 220px; cursor: pointer; 
        }

        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn { border: 1px solid #d1d5da; padding: 8px 14px; cursor: pointer; background: white; border-radius: 6px; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Chart & Details */
        .chart-container { position: relative; width: 100%; min-height: 300px; max-height: 450px; }
        #details-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }

        /* Mobile Summary Table */
        #mobile-summary { display: none; margin-top: 20px; }
        #mobile-summary table { width: 100%; border-collapse: collapse; font-size: 12px; }
        #mobile-summary th, #mobile-summary td { padding: 4px; text-align: right; border-bottom: 1px solid #eee; }
        #mobile-summary th:first-child, #mobile-summary td:first-child { text-align: left; }

        /* Details Cards */
        .ticker-card { border: 1px solid var(--border); padding: 16px; border-radius: 10px; transition: transform 0.2s, box-shadow 0.2s; background: #fff; }
        .ticker-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .price-hero { font-size: 24px; font-weight: 800; margin: 10px 0; }
        .metric-row { display: flex; justify-content: space-between; font-size: 13px; padding: 4px 0; border-bottom: 1px solid #f0f0f0; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .badge-etf { background: #e1f5fe; color: #01579b; }
        .badge-stock { background: #f3e5f5; color: #7b1fa2; }
        .pos { color: var(--success); font-weight: 600; }
        .neg { color: var(--danger); font-weight: 600; }

        .footer-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .info-card { background: var(--bg); padding: 20px; border-radius: 8px; font-size: 13px; }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .dashboard-header { padding: 15px; flex-direction: column; align-items: stretch; }
            select.nav-dropdown { width: 100%; }
            .chart-container { min-height: 300px; max-height: 320px; }
            .footer-info { grid-template-columns: 1fr; }
            #details-grid { grid-template-columns: 1fr; }
            .price-hero { font-size: 20px; }
            #mobile-summary { display: block; }
        }
    </style>
</head>
<body>

<div class="dashboard-header">
    <div class="group">
        <span class="label">Sector Analysis</span>
        <select id="sector-nav" class="nav-dropdown" onchange="setCategory(this.value)">
            <option value="battery-index">Battery Metals</option>
            <option value="last-mile">Last Mile Logistics</option>
            <option value="gig-economy">Gig Economy</option>
            <option value="mro-dist">MRO Distribution</option>
            <option value="automation-infra">Automation Infrastructure</option>
            <option value="spatial-intelligence">Mapping & Spatial Intelligence</option>              
        </select>
    </div>
    
    <div class="group">
        <span class="label">View</span>
        <div class="btn-group">
            <button id="mode-chart" class="btn active" onclick="setView('chart')">Analytics Chart</button>
            <button id="mode-details" class="btn" onclick="setView('details')">Ticker Details</button>
        </div>
    </div>

    <div class="group">
        <span class="label">Chart Metric</span>
        <div class="btn-group">
            <button id="btn-index" class="btn active" onclick="setMetric('index')">Performance</button>
            <button id="btn-price" class="btn" onclick="setMetric('price')">Price (USD)</button>
        </div>
    </div>

    <div class="group">
        <span class="label">Timeframe</span>
        <div class="btn-group">
            <button id="btn-full" class="btn active" onclick="setTimeframe('all')">Full History</button>
            <button id="btn-12m" class="btn" onclick="setTimeframe('12m')">Last 12 Months</button>
        </div>
    </div>
</div>

<h2 id="view-title" style="margin-bottom:5px;">Sector Index</h2>
<p id="sector-description" style="color:#666;margin-top:0;font-size:14px;"></p>

<div id="chart-view">
    <div class="chart-container">
        <canvas id="tangentChart"></canvas>
    </div>

    <div id="mobile-summary">
        <table>
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Price</th>
                    <th>YTD</th>
                    <th>24M</th>
                </tr>
            </thead>
            <tbody id="summary-body"></tbody>
        </table>
    </div>

    <div class="footer-info">
        <div class="info-card">
            <span id="update-ts" style="font-weight: bold; color: var(--primary);">Loading...</span><br><br>
            <strong>Market-Cap & Net Asset Weighted Index</strong>
            <p>
                This benchmark is constructed using valuation-based weights—Market Capitalization for equities and Net Assets for ETFs—rather than a simple equal-weighted average. 
                Larger constituents exert proportionally greater influence on index performance, reflecting real-world capital allocation. Individual constituent weights are capped at 30% and excess weight redistributed proportionally.
            </p>
        </div>
        <div class="info-card">
            <strong>Chart Interaction & Methodology Notes</strong>
            <ul>
                <li><strong>Legend Controls:</strong> Click a ticker to isolate or toggle individual series.</li>
                <li><strong>Weighted Index Line:</strong> Black line represents aggregate sector performance adjusted for size/capitalization.</li>
            </ul>
        </div>
    </div>
</div>

<div id="details-grid"></div>

<script>
let myChart;
let globalData = {};
let currentCategory = 'battery-index';
let currentMetric = 'index';
let currentView = 'chart';
let currentTimeframe = 'all';

const MAX_WEIGHT = 0.30;
const formatter = new Intl.NumberFormat('en-US', { notation: 'compact', maximumFractionDigits: 1 });
const curFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

async function fetchData() {
    const url = `../${currentCategory}/data.json`;
    try {
        const response = await fetch(url);
        globalData = await response.json();
        processSectorLabel();
        render();
    } catch (e) {
        console.error("Fetch error:", e);
    }
}

function processSectorLabel() {
    const tickers = Object.values(globalData);
    const allETFs = tickers.every(t => t.metadata.type === 'ETF');
    const hasETFs = tickers.some(t => t.metadata.type === 'ETF');
    let suffix = "";
    if(allETFs) suffix = " (ETFs)";
    else if(hasETFs) suffix = " (Includes ETFs)";
    const sectorName = document.querySelector(`#sector-nav option[value="${currentCategory}"]`).text;
    document.getElementById('view-title').innerText = `${sectorName}${suffix}`;
}

function setCategory(cat){ currentCategory=cat; fetchData(); }
function setMetric(met){ 
    currentMetric=met; 
    document.getElementById('btn-index').classList.toggle('active',met==='index');
    document.getElementById('btn-price').classList.toggle('active',met==='price');
    render(); 
}
function setView(view){ 
    currentView=view; 
    document.getElementById('mode-chart').classList.toggle('active',view==='chart');
    document.getElementById('mode-details').classList.toggle('active',view==='details');
    render(); 
}
function setTimeframe(tf){
    currentTimeframe = tf;
    document.getElementById('btn-full').classList.toggle('active',tf==='all');
    document.getElementById('btn-12m').classList.toggle('active',tf==='12m');
    render();
}

// Filtering labels/data for timeframe
function filterLabelsAndData(labels, dataArrays){
    if(currentTimeframe==='12m'){
        const now = new Date();
        const oneYearAgo = new Date(); oneYearAgo.setFullYear(now.getFullYear()-1);
        const idxStart = labels.findIndex(d=>new Date(d)>=oneYearAgo);
        return { labels: labels.slice(idxStart), dataArrays: dataArrays.map(arr=>arr.slice(idxStart)) };
    }
    return { labels, dataArrays };
}

function render() {
    const firstTicker = Object.keys(globalData)[0];
    if(!firstTicker) return;
    const lastEntry = globalData[firstTicker].prices.slice(-1)[0];
    document.getElementById('update-ts').innerText = `Data Updated: ${lastEntry.date}`;

    if(currentView==='chart'){
        document.getElementById('chart-view').style.display='block';
        document.getElementById('details-grid').style.display='none';
        renderChart();
    } else {
        document.getElementById('chart-view').style.display='none';
        document.getElementById('details-grid').style.display='grid';
        renderDetails();
    }
}

// Chart rendering with timeframe filter
function renderChart(){
    const tickers = Object.keys(globalData);
    if(!tickers.length) return;
    const labels = globalData[tickers[0]].prices.map(p=>p.date);
    const colors = ['#28a745','#0366d6','#6f42c1','#f66a0a','#ffd33d','#d73a49','#00bcd4'];

    let datasets = tickers.map((t,i)=>{
        const prices = globalData[t].prices;
        const basePrice = prices[0].price;
        return { label:t, data: prices.map(p=>currentMetric==='index'? (p.price/basePrice*100).toFixed(2):p.price), borderColor:colors[i%colors.length], backgroundColor:colors[i%colors.length], borderWidth:2, pointRadius:1, fill:false };
    });

    if(currentMetric==='index'){
        const rawWeights={}, totalVal=tickers.reduce((sum,t)=>sum+(globalData[t].metadata.valuation||0),0);
        tickers.forEach(t=>rawWeights[t]=(globalData[t].metadata.valuation||0)/totalVal);
        let cappedWeights={}, excess=0, uncappedTotal=0;
        tickers.forEach(t=>{ if(rawWeights[t]>MAX_WEIGHT){ cappedWeights[t]=MAX_WEIGHT; excess+=rawWeights[t]-MAX_WEIGHT; } else{ cappedWeights[t]=rawWeights[t]; uncappedTotal+=rawWeights[t]; } });
        tickers.forEach(t=>{ if(rawWeights[t]<=MAX_WEIGHT) cappedWeights[t]+=(rawWeights[t]/uncappedTotal)*excess; });
        const weightedData = labels.map((_,i)=> tickers.reduce((sum,t)=>sum+(globalData[t].prices[i].price/globalData[t].prices[0].price*100)*cappedWeights[t],0).toFixed(2));
        datasets.unshift({ label:"COMPOSITE BENCHMARK", data:weightedData, borderColor:'#1a1a1a', borderWidth:4, pointRadius:0, order:-1 });
    }

    const filtered = filterLabelsAndData(labels, datasets.map(d=>d.data));
    filtered.dataArrays.forEach((arr,i)=>datasets[i].data=arr);

    if(myChart) myChart.destroy();
    const allValues=datasets.flatMap(d=>d.data.map(Number));
    const yMin=Math.min(...allValues)*0.95;
    const yMax=Math.max(...allValues)*1.05;

    myChart = new Chart(document.getElementById('tangentChart'), {
        type:'line',
        data:{ labels: filtered.labels, datasets },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            interaction:{ mode:'index', intersect:false },
            plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, padding:20 } } },
            scales:{ y:{ min:yMin, max:yMax, grid:{color:'#f0f0f0'}, title:{display:true,text:currentMetric==='index'?'Performance (Base 100)':'Price (USD)'} }, x:{ grid:{display:false} } },
            animation:{ onComplete:sendHeight }
        }
    });

    renderMobileSummary(filtered.labels);
}

// Mobile summary table
function renderMobileSummary(labels){
    const isMobile = window.innerWidth<768;
    const summaryDiv=document.getElementById('mobile-summary');
    const tbody=document.getElementById('summary-body');
    tbody.innerHTML='';
    if(!isMobile){ summaryDiv.style.display='none'; return; }
    summaryDiv.style.display='block';
    Object.keys(globalData).forEach(t=>{
        const m=globalData[t].metadata;
        const latestPrice = globalData[t].prices.slice(-1)[0].price;
        const row = document.createElement('tr');
        row.innerHTML=`
            <td>${m.name}</td>
            <td>${curFormatter.format(latestPrice)}</td>
            <td class="${m.ytd_growth.startsWith('-')?'neg':'pos'}">${m.ytd_growth}</td>
            <td class="${m.total_return.startsWith('-')?'neg':'pos'}">${m.total_return}</td>
        `;
        tbody.appendChild(row);
    });
}

function renderDetails() {
    const grid = document.getElementById('details-grid');
    grid.innerHTML='';
    Object.keys(globalData).forEach(t=>{
        const m=globalData[t].metadata;
        const latestPrice = globalData[t].prices.slice(-1)[0].price;
        const card=document.createElement('div');
        card.className='ticker-card';
        const ytdClass = m.ytd_growth.startsWith('-')?'neg':'pos';
        const totClass = m.total_return.startsWith('-')?'neg':'pos';
        card.innerHTML=`
            <div class="card-header">
                <strong>${m.name}</strong>
                <span class="badge ${m.type==='ETF'?'badge-etf':'badge-stock'}">${m.type}</span>
            </div>
            <div class="price-hero">${curFormatter.format(latestPrice)}</div>
            <div class="metric-row"><span>Valuation</span> <strong>${formatter.format(m.valuation)}</strong></div>
            <div class="metric-row"><span>YTD Growth</span> <strong class="${ytdClass}">${m.ytd_growth}</strong></div>
            <div class="metric-row"><span>24M Return</span> <strong class="${totClass}">${m.total_return}</strong></div>
            <p style="font-size:12px;color:#666;margin:15px 0;">${m.summary.substring(0,140)}...</p>
            <div style="font-size:11px;color:#999;border-top:1px solid #eee;padding-top:10px;">
                Top Holdings: ${Array.isArray(m.holdings)?m.holdings.join(', '):m.holdings}
            </div>
        `;
        grid.appendChild(card);
    });
}

// Iframe height adjustment
function sendHeight(){ const h=document.body.scrollHeight; window.parent.postMessage({'setHeight':h},'*'); }

fetchData();
const originalRender = render;
render = function(){ originalRender(); setTimeout(sendHeight,200); };
</script>
</body>
</html>
