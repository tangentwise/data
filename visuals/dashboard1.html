<!DOCTYPE html>
<html> 
<head>
    <title>Tangentwise Sector Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    :root { --primary: #0366d6; --bg: #f8f9fa; --border: #e1e4e8; --text: #1a1a1a; --success: #28a745; --danger: #d73a49; }

    html, body {
        overflow-x: hidden;
        margin: 0;
        padding: 0;
    }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        padding: 5px; 
        color: var(--text); 
        background: white; 
        line-height: 1.2; 
        font-size: 12px; 
    }

    /* Compact Header for Narrow Containers */
    .dashboard-header { 
        display: flex; 
        flex-direction: column; 
        gap: 10px; 
        margin-bottom: 12px; 
        background: var(--bg); 
        padding: 10px; 
        border-radius: 6px; 
        border: 1px solid var(--border); 
    }
    
    @media (min-width: 1200px) {
        .dashboard-header {
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
        }
    }

    .group { display: flex; flex-direction: column; gap: 4px; }
    .label { font-size: 9px; font-weight: 700; color: #6a737d; text-transform: uppercase; }
    
    select.nav-dropdown { padding: 4px 6px; font-size: 11px; width: 100%; border-radius: 4px; }
    .btn-group { display: flex; width: 100%; }
    .btn { flex: 1; padding: 5px 6px; font-size: 10.5px; text-align: center; border: 1px solid #d1d5da; background: white; cursor: pointer; }
    .btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Chart */
    .chart-container { 
        position: relative; 
        width: 100% !important;
        height: 32vh; 
        min-height: 200px; 
        margin-bottom: 10px;
    }

    /* Ticker Details */
    #details-grid { 
        display: none; 
        grid-template-columns: 1fr; 
        gap: 10px; 
    }

    @media (min-width: 1200px) {
        #details-grid { grid-template-columns: 1fr 1fr; }
    }

    .ticker-card { border: 1px solid var(--border); padding: 10px; border-radius: 6px; background: #fff; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .price-hero { font-size: 18px; font-weight: 800; margin: 2px 0; }
    .metric-row { display: flex; justify-content: space-between; font-size: 11px; padding: 2px 0; border-bottom: 1px solid #f0f0f0; }
    
    .footer-info { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
    .info-card { background: var(--bg); padding: 10px; border-radius: 6px; font-size: 11px; }

    @media (max-width: 600px) {
        h2 { font-size: 16px; }
        .chart-container { height: 26vh; min-height: 190px; }
    }
    </style>
</head>
<body>

<div class="dashboard-header">
    <div class="group">
        <span class="label">Sector Analysis</span>
        <select id="sector-nav" class="nav-dropdown" onchange="setCategory(this.value)">
            <option value="battery-index">Battery Metals</option>
            <option value="last-mile">Last Mile Logistics</option>
            <option value="gig-economy">Gig Economy</option>
            <option value="mro-dist">MRO Distribution</option>
            <option value="automation-infra">Automation Infrastructure</option>
            <option value="spatial-intelligence">Mapping & Spatial Intelligence</option>              
        </select>
    </div>
    
    <div class="group">
        <span class="label">View</span>
        <div class="btn-group">
            <button id="mode-chart" class="btn active" onclick="setView('chart')">Analytics Chart</button>
            <button id="mode-details" class="btn" onclick="setView('details')">Ticker Details</button>
        </div>
    </div>

    <div class="group">
        <span class="label">Chart Metric</span>
        <div class="btn-group">
            <button id="btn-index" class="btn active" onclick="setMetric('index')">Performance</button>
            <button id="btn-price" class="btn" onclick="setMetric('price')">Price (USD)</button>
        </div>
    </div>
</div>

<h2 id="view-title" style="margin-bottom: 5px;">Sector Index</h2>
<p id="sector-description" style="color: #666; margin-top: 0; font-size: 14px;"></p>

<div id="chart-view">
    <div class="chart-container">
        <canvas id="tangentChart"></canvas>
    </div>
   <div class="footer-info">
    <div class="info-card">
        <span id="update-ts" style="font-weight: bold; color: var(--primary);">Loading...</span><br><br>
        <strong>Market-Cap & Net Asset Weighted Index</strong>
        <p>
            This benchmark is constructed using valuation-based weights—Market Capitalization for equities and Net Assets for ETFs—rather than a simple equal-weighted average. 
            Larger constituents exert proportionally greater influence. We cap individual weights at 30% and redistribute excess.
        </p>
    </div>
    <div class="info-card">
        <strong>Chart Interaction & Methodology Notes</strong>
        <ul>
            <li><strong>Legend Controls:</strong> Click a ticker to isolate or toggle series.</li>
            <li><strong>Weighted Index Line:</strong> Black line represents size-adjusted aggregate performance.</li>
        </ul>
    </div>
</div>
</div>

<div id="details-grid"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

let myChart;
let globalData = {};
let currentCategory = 'battery-index';
let currentMetric = 'index';
let currentView = 'chart';

const MAX_WEIGHT = 0.30;
const formatter = new Intl.NumberFormat('en-US', { notation: 'compact', maximumFractionDigits: 1 });
const curFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

async function fetchData() {
    const url = `../${currentCategory}/data.json`;
    try {
        const response = await fetch(url);
        globalData = await response.json();
        processSectorLabel();
        render();
    } catch (e) {
        console.error("Fetch error:", e);
    }
}

function processSectorLabel() {
    const tickers = Object.values(globalData);
    const allETFs = tickers.every(t => t.metadata.type === 'ETF');
    const hasETFs = tickers.some(t => t.metadata.type === 'ETF');
    
    let suffix = "";
    if (allETFs) suffix = " (ETFs)";
    else if (hasETFs) suffix = " (Includes ETFs)";

    const sectorName = document.querySelector(`#sector-nav option[value="${currentCategory}"]`).text;
    document.getElementById('view-title').innerText = `${sectorName}${suffix}`;
}

function render() {
    const firstTicker = Object.keys(globalData)[0];
    if(!firstTicker) return;
    const lastEntry = globalData[firstTicker].prices.slice(-1)[0];
    document.getElementById('update-ts').innerText = `Data Updated: ${lastEntry.date}`;

    if (currentView === 'chart') {
        document.getElementById('chart-view').style.display = 'block';
        document.getElementById('details-grid').style.display = 'none';
        renderChart();
    } else {
        document.getElementById('chart-view').style.display = 'none';
        document.getElementById('details-grid').style.display = 'grid';
        renderDetails();
    }
}

function renderChart() {
    const tickers = Object.keys(globalData);
    if(!tickers.length) return;
    const labels = globalData[tickers[0]].prices.map(p => p.date);
    const colors = ['#28a745', '#0366d6', '#6f42c1', '#f66a0a', '#ffd33d', '#d73a49', '#00bcd4'];

    const datasets = tickers.map((t, i) => {
        const prices = globalData[t].prices;
        const basePrice = prices[0].price;
        return {
            label: t,
            data: prices.map(p => currentMetric === 'index' ? +(p.price / basePrice * 100).toFixed(2) : p.price),
            borderColor: colors[i % colors.length],
            backgroundColor: colors[i % colors.length],
            borderWidth: 2,
            pointRadius: 1,
            fill: false
        };
    });

    if (currentMetric === 'index') {
        const rawWeights = {};
        const totalValuation = tickers.reduce((sum, t) => sum + (globalData[t].metadata.valuation || 0), 0);
        tickers.forEach(t => { rawWeights[t] = (globalData[t].metadata.valuation || 0) / totalValuation; });

        let cappedWeights = {};
        let excessWeight = 0;
        let uncappedTotal = 0;
        tickers.forEach(t => {
            if(rawWeights[t] > MAX_WEIGHT) { cappedWeights[t] = MAX_WEIGHT; excessWeight += rawWeights[t] - MAX_WEIGHT; }
            else { cappedWeights[t] = rawWeights[t]; uncappedTotal += rawWeights[t]; }
        });

        tickers.forEach(t => { if(rawWeights[t] <= MAX_WEIGHT) { cappedWeights[t] += (rawWeights[t]/uncappedTotal)*excessWeight; } });

        const weightedData = labels.map((_, i) => {
            let sum = 0;
            tickers.forEach(t => { sum += (globalData[t].prices[i].price / globalData[t].prices[0].price * 100) * cappedWeights[t]; });
            return +sum.toFixed(2);
        });

        datasets.unshift({ label: `COMPOSITE BENCHMARK`, data: weightedData, borderColor: '#1a1a1a', borderWidth: 4, pointRadius: 0, order: -1 });
    }

    if(myChart) myChart.destroy();
    myChart = new Chart(document.getElementById('tangentChart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10, font:{size:10} } } },
            scales: { 
                y: { ticks:{ font:{size:10} }, title:{ display:false } },
                x: { ticks:{ font:{size:10}, maxRotation:45, minRotation:45, autoSkip:true, maxTicksLimit:8 } }
            }
        }
    });
}

function renderDetails() {
    const grid = document.getElementById('details-grid');
    grid.innerHTML = '';
    Object.keys(globalData).forEach(t => {
        const m = globalData[t].metadata;
        const latestPrice = globalData[t].prices.slice(-1)[0].price;
        const card = document.createElement('div');
        card.className = 'ticker-card';
        const ytdClass = m.ytd_growth.startsWith('-') ? 'neg' : 'pos';
        const totClass = m.total_return.startsWith('-') ? 'neg' : 'pos';

        card.innerHTML = `
            <div class="card-header">
                <strong>${m.name}</strong>
                <span class="badge ${m.type==='ETF'?'badge-etf':'badge-stock'}">${m.type}</span>
            </div>
            <div class="price-hero">${curFormatter.format(latestPrice)}</div>
            <div class="metric-row"><span>Valuation</span> <strong>${formatter.format(m.valuation)}</strong></div>
            <div class="metric-row"><span>YTD Growth</span> <strong class="${ytdClass}">${m.ytd_growth}</strong></div>
            <div class="metric-row"><span>24M Return</span> <strong class="${totClass}">${m.total_return}</strong></div>
            <p style="font-size:12px;color:#666;margin:15px 0;">${m.summary.substring(0,140)}...</p>
            <div style="font-size:11px;color:#999;border-top:1px solid #eee;padding-top:10px;">
                Top Holdings: ${Array.isArray(m.holdings)?m.holdings.join(', '):m.holdings}
            </div>
        `;
        grid.appendChild(card);
    });
}

function setCategory(cat){ currentCategory=cat; fetchData(); }
function setMetric(met){ currentMetric=met; document.getElementById('btn-index').classList.toggle('active',met==='index'); document.getElementById('btn-price').classList.toggle('active',met==='price'); render(); }
function setView(view){ currentView=view; document.getElementById('mode-chart').classList.toggle('active',view==='chart'); document.getElementById('mode-details').classList.toggle('active',view==='details'); render(); }

function sendHeight(){ window.parent.postMessage({ setHeight:document.body.scrollHeight }, '*'); }

fetchData();

// Override render to send iframe height
const originalRender = render;
render = function(){ originalRender(); setTimeout(sendHeight,200); };

});
</script>
</body>
</html>
