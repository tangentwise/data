<!DOCTYPE html>
<html>
<head>
    <title>Tangentwise Categorical Index Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; color: #1a1a1a; }
        .dashboard-controls { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #e1e4e8; }
        .group { display: flex; flex-direction: column; gap: 8px; }
        .label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #6a737d; }
        .btn-group { display: flex; gap: 5px; }
        .btn { border: 1px solid #d1d5da; padding: 8px 14px; cursor: pointer; background: white; border-radius: 6px; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .btn:hover { background: #f3f4f6; border-color: #0366d6; }
        .btn.active { background: #0366d6; color: white; border-color: #0366d6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 70vh; width: 100%; min-height: 400px; }
    </style>
</head>
<body>

<div class="dashboard-controls">
    <div class="group">
        <span class="label">Sector Analysis</span>
        <div class="btn-group">
            <button id="btn-battery" class="btn active" onclick="setCategory('battery-index')">Battery Metals</button>
            <button id="btn-logistics" class="btn" onclick="setCategory('last-mile')">Last Mile</button>
        </div>
    </div>
    <div class="group">
        <span class="label">Metric Type</span>
        <div class="btn-group">
            <button id="btn-index" class="btn active" onclick="setMetric('index')">Growth (Base 100)</button>
            <button id="btn-price" class="btn" onclick="setMetric('price')">Price (USD)</button>
        </div>
    </div>
</div>

<div class="chart-container">
    <canvas id="tangentChart"></canvas>
</div>

<script>
let myChart;
let currentCategory = 'battery-index';
let currentMetric = 'index';

async function renderDashboard() {
    // Relative path: goes up one level from 'visuals' to find the index folders
    const url = `../${currentCategory}/data.json`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        const tickers = Object.keys(data);
        const labels = data[tickers[0]].map(d => d.date);
        const colors = ['#28a745', '#0366d6', '#6f42c1', '#f66a0a', '#ffd33d'];

        const datasets = tickers.map((ticker, i) => {
            const basePrice = data[ticker][0].price;
            return {
                label: ticker,
                data: data[ticker].map(d => {
                    return currentMetric === 'index' 
                        ? (d.price / basePrice * 100).toFixed(2) 
                        : d.price;
                }),
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length],
                borderWidth: currentMetric === 'index' ? 1.5 : 2.5,
                pointRadius: 2,
                tension: 0.1,
                fill: false,
                hidden: currentMetric === 'index' ? true : false 
            };
        });

        if (currentMetric === 'index') {
            const compositeData = labels.map((_, i) => {
                let sum = 0;
                tickers.forEach(t => sum += (data[t][i].price / data[t][0].price * 100));
                return (sum / tickers.length).toFixed(2);
            });

            datasets.unshift({
                label: `TANGENTWISE COMPOSITE`,
                data: compositeData,
                borderColor: '#1b1f23',
                borderWidth: 4,
                pointRadius: 0,
                hidden: false,
                fill: false
            });
        }

        if (myChart) myChart.destroy();
        const ctx = document.getElementById('tangentChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                    tooltip: { padding: 12, cornerRadius: 8 }
                },
                scales: {
                    y: {
                        grid: { color: '#f0f0f0' },
                        title: { display: true, text: currentMetric === 'index' ? 'Index (Start = 100)' : 'Price (USD)' },
                        ticks: { callback: (val) => currentMetric === 'price' ? '$' + val : val }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    } catch (err) {
        console.error("Data failed to load:", err);
    }
}

function setCategory(cat) {
    currentCategory = cat;
    document.getElementById('btn-battery').classList.toggle('active', cat === 'battery-index');
    document.getElementById('btn-logistics').classList.toggle('active', cat === 'last-mile');
    renderDashboard();
}

function setMetric(met) {
    currentMetric = met;
    document.getElementById('btn-index').classList.toggle('active', met === 'index');
    document.getElementById('btn-price').classList.toggle('active', met === 'price');
    renderDashboard();
}

renderDashboard();
</script>
</body>
</html>
