<!DOCTYPE html>
<html>
<head>
    <title>Tangentwise Intelligence Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0366d6; --bg: #f8f9fa; --border: #e1e4e8; --text: #1a1a1a; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; color: var(--text); background: white; }
        
        /* Controls */
        .dashboard-header { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .group { display: flex; flex-direction: column; gap: 8px; }
        .label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #6a737d; }
        .btn-group { display: flex; gap: 5px; }
        .btn { border: 1px solid #d1d5da; padding: 8px 14px; cursor: pointer; background: white; border-radius: 6px; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Chart & UI */
        .chart-container { position: relative; height: 60vh; width: 100%; min-height: 400px; margin-bottom: 20px; }
        
        /* The Key / Metadata Section */
        .footer-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; border-top: 2px solid var(--bg); margin-top: 20px; font-size: 14px; }
        .info-card { background: var(--bg); padding: 15px; border-radius: 8px; }
        .timestamp { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; }
        
        /* Summary Grid */
        #summary-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .ticker-card { border: 1px solid var(--border); padding: 15px; border-radius: 8px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 5px; background: #e1f5fe; color: #01579b; }
        .return-pos { color: #28a745; } .return-neg { color: #d73a49; }
    </style>
</head>
<body>

<div class="dashboard-header">
    <div class="group">
        <span class="label">Sector Analysis</span>
        <div class="btn-group">
            <button id="btn-battery" class="btn active" onclick="setCategory('battery-index')">Battery Metals</button>
            <button id="btn-logistics" class="btn" onclick="setCategory('last-mile')">Last Mile</button>
        </div>
    </div>
    <div class="group">
        <span class="label">View Mode</span>
        <div class="btn-group">
            <button id="mode-chart" class="btn active" onclick="setView('chart')">Analytics Chart</button>
            <button id="mode-summary" class="btn" onclick="setView('summary')">Fundamentals</button>
        </div>
    </div>
    <div class="group">
        <span class="label">Metric (Chart Only)</span>
        <div class="btn-group">
            <button id="btn-index" class="btn active" onclick="setMetric('index')">Performance</button>
            <button id="btn-price" class="btn" onclick="setMetric('price')">Share Price (USD)</button>
        </div>
    </div>
</div>

<div id="chart-view">
    <div class="chart-container">
        <canvas id="tangentChart"></canvas>
    </div>
    
    <div class="footer-info">
        <div class="info-card">
            <span id="update-ts" class="timestamp">Loading updates...</span>
            <strong>About Composite Benchmark:</strong>
            <p style="margin: 5px 0;">This benchmark represents the mathematically weighted average of all tickers in this sector, indexed to 100 at the start of the 24-month period. This allows for direct growth comparison regardless of individual share prices.</p>
        </div>
        <div class="info-card">
            <strong>Legend Guide:</strong>
            <ul style="margin: 5px 0; padding-left: 18px;">
                <li><strong>Performance:</strong> Indexed growth from 24 months ago.</li>
                <li><strong>Share Price:</strong> Real-time nominal value in USD.</li>
                <li>Hover over lines to see specific monthly data points.</li>
            </ul>
        </div>
    </div>
</div>

<div id="summary-grid"></div>

<script>
let myChart;
let globalData = {};
let currentCategory = 'battery-index';
let currentMetric = 'index';
let currentView = 'chart';

async function fetchData() {
    const url = `../${currentCategory}/data.json`;
    const response = await fetch(url);
    globalData = await response.json();
    
    // Set Timestamp
    const firstTicker = Object.keys(globalData)[0];
    const lastEntry = globalData[firstTicker].prices.slice(-1)[0];
    document.getElementById('update-ts').innerText = `Data as of: ${lastEntry.date} | Timespan: 24 Months`;
    
    render();
}

function render() {
    if (currentView === 'chart') {
        document.getElementById('chart-view').style.display = 'block';
        document.getElementById('summary-grid').style.display = 'none';
        renderChart();
    } else {
        document.getElementById('chart-view').style.display = 'none';
        document.getElementById('summary-grid').style.display = 'grid';
        renderSummary();
    }
}

function renderChart() {
    const tickers = Object.keys(globalData);
    const labels = globalData[tickers[0]].prices.map(p => p.date);
    const colors = ['#28a745', '#0366d6', '#6f42c1', '#f66a0a', '#ffd33d'];

    const datasets = tickers.map((t, i) => {
        const meta = globalData[t].metadata;
        const prices = globalData[t].prices;
        const basePrice = prices[0].price;

        return {
            label: `${t} (${meta.total_return})`,
            data: prices.map(p => currentMetric === 'index' ? (p.price / basePrice * 100).toFixed(2) : p.price),
            borderColor: colors[i % colors.length],
            borderWidth: currentMetric === 'index' ? 1.5 : 2.5,
            pointRadius: 2,
            hidden: false, // Defaulting to ON as requested
            fill: false
        };
    });

    if (currentMetric === 'index') {
        const compositeData = labels.map((_, i) => {
            let sum = 0;
            tickers.forEach(t => sum += (globalData[t].prices[i].price / globalData[t].prices[0].price * 100));
            return (sum / tickers.length).toFixed(2);
        });
        datasets.unshift({
            label: `COMPOSITE BENCHMARK`,
            data: compositeData,
            borderColor: '#1b1f23',
            borderWidth: 4,
            pointRadius: 0,
            fill: false
        });
    }

    if (myChart) myChart.destroy();
    myChart = new Chart(document.getElementById('tangentChart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { title: { display: true, text: currentMetric === 'index' ? 'Performance (100)' : 'USD' } } }
        }
    });
}

function renderSummary() {
    const grid = document.getElementById('summary-grid');
    grid.innerHTML = '';
    Object.keys(globalData).forEach(t => {
        const m = globalData[t].metadata;
        const card = document.createElement('div');
        card.className = 'ticker-card';
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <strong>${m.name} (${t})</strong>
                <span class="badge">${m.type}</span>
            </div>
            <p style="font-size:12px; color: #666; margin: 10px 0;">${m.summary.substring(0, 150)}...</p>
            <div style="font-size:13px;">
                <div><strong>${m.metric}</strong></div>
                <div class="return-pos">Total Return: ${m.total_return}</div>
                <div class="return-pos" title="12-Month Return">1-Year: ${m.return_12m}</div>
                <div style="margin-top:8px; font-size:11px; color:#888;">
                    Top Holdings: ${Array.isArray(m.holdings) ? m.holdings.join(', ') : m.holdings}
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

// Controls
function setCategory(cat) { 
    currentCategory = cat; 
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${cat.split('-')[0]}`).classList.add('active');
    fetchData(); 
}
function setMetric(met) { 
    currentMetric = met; 
    document.getElementById('btn-index').classList.toggle('active', met === 'index');
    document.getElementById('btn-price').classList.toggle('active', met === 'price');
    render(); 
}
function setView(view) { 
    currentView = view; 
    document.getElementById('mode-chart').classList.toggle('active', view === 'chart');
    document.getElementById('mode-summary').classList.toggle('active', view === 'summary');
    render(); 
}

fetchData();
</script>
</body>
</html>
